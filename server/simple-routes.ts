import type { Express, Request, Response } from "express";
import { createServer, type Server } from "http";
import cookieParser from "cookie-parser";

export async function registerRoutes(app: Express): Promise<Server> {
  console.log("ðŸ”„ Setting up simple routes...");

  // Add cookie parser middleware
  app.use(cookieParser());

  // Health check endpoint
  app.get('/api/health', (req: Request, res: Response) => {
    res.json({ status: 'ok', timestamp: new Date().toISOString() });
  });

  // Session storage for logged in users
  const sessions = new Map<string, any>();

  // Login endpoint
  app.post('/api/login', async (req: Request, res: Response) => {
    try {
      const { username, password, email } = req.body;
      const loginField = username || email;
      
      const validCredentials = [
        { field: 'demo@example.com', pass: 'demo-password', user: { id: 'demo-user', username: 'tracer-user', email: 'demo@example.com', role: 'sales-agent' }},
        { field: 'tracer-user', pass: 'demo-password', user: { id: 'demo-user', username: 'tracer-user', email: 'demo@example.com', role: 'sales-agent' }},
        { field: 'admin@jacc.com', pass: 'admin123', user: { id: 'admin-user', username: 'admin', email: 'admin@jacc.com', role: 'admin' }},
        { field: 'admin', pass: 'admin123', user: { id: 'admin-user', username: 'admin', email: 'admin@jacc.com', role: 'admin' }},
        { field: 'demo', pass: 'demo', user: { id: 'demo-simple', username: 'demo', email: 'demo@demo.com', role: 'user' }}
      ];
      
      const validUser = validCredentials.find(cred => 
        cred.field === loginField && cred.pass === password
      );
      
      if (validUser) {
        // Store session
        const sessionId = Math.random().toString(36).substring(2);
        sessions.set(sessionId, validUser.user);
        
        // Set cookie
        res.cookie('sessionId', sessionId, { 
          httpOnly: true, 
          secure: false,
          maxAge: 24 * 60 * 60 * 1000
        });
        
        res.json({
          success: true,
          user: validUser.user
        });
      } else {
        res.status(401).json({ error: 'Invalid credentials' });
      }
    } catch (error) {
      console.error('Login error:', error);
      res.status(500).json({ error: 'Login failed' });
    }
  });

  // User session endpoint
  app.get('/api/user', (req: Request, res: Response) => {
    try {
      const sessionId = req.cookies?.sessionId;
      if (sessionId && sessions.has(sessionId)) {
        const user = sessions.get(sessionId);
        res.json(user);
      } else {
        res.status(401).json({ error: 'Not authenticated' });
      }
    } catch (error) {
      console.error('User fetch error:', error);
      res.status(500).json({ error: 'Failed to fetch user' });
    }
  });

  // Logout endpoint
  app.post('/api/logout', (req: Request, res: Response) => {
    try {
      const sessionId = req.cookies?.sessionId;
      if (sessionId) {
        sessions.delete(sessionId);
        res.clearCookie('sessionId');
      }
      res.json({ success: true });
    } catch (error) {
      console.error('Logout error:', error);
      res.status(500).json({ error: 'Logout failed' });
    }
  });

  // Support alternative login endpoints
  app.post('/api/auth/simple-login', async (req: Request, res: Response) => {
    // Redirect to main login handler
    const loginHandler = app._router.stack.find((layer: any) => 
      layer.route && layer.route.path === '/api/login' && layer.route.methods.post
    );
    if (loginHandler) {
      return loginHandler.route.stack[0].handle(req, res);
    }
    res.status(500).json({ error: 'Login handler not found' });
  });

  // Basic chat endpoint
  app.post('/api/chat', async (req: Request, res: Response) => {
    try {
      const { message } = req.body;
      res.json({
        response: `Echo: ${message}`,
        timestamp: new Date().toISOString()
      });
    } catch (error) {
      console.error('Chat error:', error);
      res.status(500).json({ error: 'Chat failed' });
    }
  });

  // Basic folders endpoint
  app.get('/api/folders', (req: Request, res: Response) => {
    res.json([]);
  });

  // Basic chats endpoint
  app.get('/api/chats', (req: Request, res: Response) => {
    res.json([]);
  });

  // Basic documents endpoint
  app.get('/api/documents', (req: Request, res: Response) => {
    res.json([]);
  });

  console.log("âœ… Simple routes registered successfully");
  
  const server = createServer(app);
  return server;
}